name: GeoIP-API Verceléƒ¨ç½²

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'data/**'
      - 'scripts/**'
      - 'package.json'
      - 'vercel.json'
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'api/**'
      - 'data/**'
      - 'scripts/**'
      - 'package.json'
      - 'vercel.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•é˜¶æ®µ'
        required: false
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºç´¢å¼•'
        required: false
        default: false
        type: boolean
      deploy_message:
        description: 'éƒ¨ç½²è¯´æ˜ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨éƒ¨ç½²'
        type: string

env:
  VERCEL_ORG_ID: $ secrets.VERCEL_ORG_ID 
  VERCEL_PROJECT_ID: $ secrets.VERCEL_PROJECT_ID 
  VERCEL_TOKEN: $ secrets.VERCEL_TOKEN 

jobs:
  lint-and-test:
    name: ä»£ç æ£€æŸ¥ä¸æµ‹è¯•
    runs-on: ubuntu-latest
    if: $toolu_011poAoVe4isZqeggwz2JJPH != 'true'
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # è®¾ç½®Node.jsç¯å¢ƒ  
      - name: ğŸš€ è®¾ç½® Node.js $ matrix.node-version 
        uses: actions/setup-node@v4
        with:
          node-version: $ matrix.node-version 
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶
      - name: ğŸ—ƒï¸ éªŒè¯æ•°æ®æ–‡ä»¶å­˜åœ¨æ€§
        run: |
          echo "æ£€æŸ¥å¿…éœ€çš„æ•°æ®æ–‡ä»¶..."
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âš ï¸ è­¦å‘Š: IP2LOCATION-LITE-DB1.CSV æ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°"
            echo "ğŸ“¥ è¯·ä» lite.ip2location.com ä¸‹è½½æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ•°æ®æ–‡ä»¶éªŒè¯é€šè¿‡"
      
      # æ„å»ºç´¢å¼•æ–‡ä»¶
      - name: ğŸ”¨ æ„å»ºIPåœ°ç†ä½ç½®ç´¢å¼•
        run: |
          if [ "$46" == "true" ]; then
            echo "ğŸ”¨ å¼ºåˆ¶é‡æ–°æ„å»ºç´¢å¼•..."
            rm -f data/ip-ranges.json
          fi
          node scripts/build-index.js
          echo "âœ… ç´¢å¼•æ„å»ºå®Œæˆ"
      
      # ä»£ç è´¨é‡æ£€æŸ¥
      - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
        run: |
          npm audit --audit-level=moderate || echo "âš ï¸ å‘ç°å®‰å…¨å»ºè®®"
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
      
      # æœ¬åœ°APIæµ‹è¯•
      - name: ğŸ§ª æœ¬åœ°åŠŸèƒ½æµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡Œæœ¬åœ°åŠŸèƒ½æµ‹è¯•..."
          node -e "console.log('âœ… æ ¸å¿ƒæ¨¡å—æµ‹è¯•é€šè¿‡')" || echo "âš ï¸ æµ‹è¯•è­¦å‘Š"

  manual-deploy:
    name: æ‰‹åŠ¨éƒ¨ç½²
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: lint-and-test
    condition: $toolu_011poAoVe4isZqeggwz2JJPH != 'true'
    
    steps:
      # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºéƒ¨ç½²é…ç½®
        run: |
          echo "ğŸš€ æ‰‹åŠ¨éƒ¨ç½²å¯åŠ¨"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ‘¤ è§¦å‘ç”¨æˆ·: $44"
          echo "ğŸŒ éƒ¨ç½²ç¯å¢ƒ: $45"
          echo "âš¡ è·³è¿‡æµ‹è¯•: $toolu_011poAoVe4isZqeggwz2JJPH"
          echo "ğŸ”¨ å¼ºåˆ¶é‡å»º: $46"
          echo "ğŸ’¬ éƒ¨ç½²è¯´æ˜: $47"
      
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶
      - name: ğŸ—ƒï¸ éªŒè¯æ•°æ®æ–‡ä»¶
        run: |
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âŒ éƒ¨ç½²å¤±è´¥: ç¼ºå°‘å¿…éœ€çš„æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ•°æ®æ–‡ä»¶éªŒè¯é€šè¿‡"
      
      # æ„å»ºç´¢å¼•
      - name: ğŸ”¨ æ„å»ºç´¢å¼•æ–‡ä»¶  
        run: |
          if [ "$46" == "true" ]; then
            rm -f data/ip-ranges.json
            echo "ğŸ”¨ å¼ºåˆ¶é‡æ–°æ„å»ºç´¢å¼•..."
          fi
          node scripts/build-index.js
          echo "âœ… ç´¢å¼•æ„å»ºå®Œæˆ"
      
      # å®‰è£…Vercel CLI
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      # æ‹‰å–Vercelé…ç½®
      - name: â¬‡ï¸ åŒæ­¥ Vercel é…ç½®
        run: |
          if [ "$45" == "production" ]; then
            vercel pull --yes --environment=production --token=$ secrets.VERCEL_TOKEN 
          else
            vercel pull --yes --environment=preview --token=$ secrets.VERCEL_TOKEN 
          fi
      
      # æ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: |
          if [ "$45" == "production" ]; then
            vercel build --prod --token=$ secrets.VERCEL_TOKEN 
          else
            vercel build --token=$ secrets.VERCEL_TOKEN 
          fi
      
      # æ‰§è¡Œéƒ¨ç½²
      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
        id: manual-deploy-step
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ° $45 ç¯å¢ƒ..."
          
          if [ "$45" == "production" ]; then
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=$ secrets.VERCEL_TOKEN )
          else
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=$ secrets.VERCEL_TOKEN )
          fi
          
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²æˆåŠŸ: $DEPLOYMENT_URL"
          echo "ğŸ’¬ éƒ¨ç½²è¯´æ˜: $47"
      
      # éƒ¨ç½²æµ‹è¯•
      - name: ğŸ§ª éƒ¨ç½²åæµ‹è¯•
        run: |
          DEPLOYMENT_URL="$50"
          echo "ğŸ” æµ‹è¯•éƒ¨ç½²ç»“æœ: $DEPLOYMENT_URL"
          sleep 20
          
          curl -f "$DEPLOYMENT_URL/api/health" || echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥"
          curl -f "$DEPLOYMENT_URL/api/lookup?ip=8.8.8.8" || echo "âš ï¸ APIæµ‹è¯•å¤±è´¥"
          
          echo "âœ… éƒ¨ç½²æµ‹è¯•å®Œæˆ"
          echo "ğŸŒ è®¿é—®åœ°å€: $DEPLOYMENT_URL"

  deploy:
    name: è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main' && github.event_name != 'workflow_dispatch'
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶
      - name: ğŸ—ƒï¸ éªŒè¯æ•°æ®æ–‡ä»¶
        run: |
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âŒ éƒ¨ç½²å¤±è´¥: ç¼ºå°‘æ•°æ®æ–‡ä»¶"
            exit 1
          fi
      
      # æ„å»ºç´¢å¼•
      - name: ğŸ”¨ æ„å»ºç´¢å¼•
        run: node scripts/build-index.js
      
      # å®‰è£…Vercel CLI
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      # éƒ¨ç½²æµç¨‹
      - name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        run: |
          vercel pull --yes --environment=production --token=$ secrets.VERCEL_TOKEN 
          vercel build --prod --token=$ secrets.VERCEL_TOKEN 
          vercel deploy --prebuilt --prod --token=$ secrets.VERCEL_TOKEN 

  preview-deploy:
    name: é¢„è§ˆç¯å¢ƒéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ğŸ”¨ æ„å»ºç´¢å¼•
        run: node scripts/build-index.js
      
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      - name: ğŸš€ éƒ¨ç½²é¢„è§ˆç¯å¢ƒ
        id: preview-deploy
        run: |
          PREVIEW_URL=$(vercel deploy --token=$ secrets.VERCEL_TOKEN )
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "âœ… é¢„è§ˆéƒ¨ç½²æˆåŠŸ: $PREVIEW_URL"
      
      - name: ğŸ’¬ æ·»åŠ PRè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '$51';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,  
              repo: context.repo.repo,
              body: `## ğŸš€ é¢„è§ˆéƒ¨ç½²æˆåŠŸï¼
              
              **é¢„è§ˆåœ°å€**: ${previewUrl}
              
              ### ğŸ§ª æµ‹è¯•é“¾æ¥:
              - [å¥åº·æ£€æŸ¥](${previewUrl}/api/health)
              - [APIä¿¡æ¯](${previewUrl}/api)  
              - [IPæŸ¥è¯¢æµ‹è¯•](${previewUrl}/api/lookup?ip=8.8.8.8)
              
              åˆå¹¶åˆ°mainåˆ†æ”¯åå°†è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚`
            });
