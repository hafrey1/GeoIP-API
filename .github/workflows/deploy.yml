name: GeoIP-API Verceléƒ¨ç½²

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'data/**'
      - 'scripts/**'
      - 'package.json'
      - 'vercel.json'
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'api/**'
      - 'data/**'
      - 'scripts/**'
      - 'package.json'
      - 'vercel.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•é˜¶æ®µ'
        required: false
        default: false
        type: boolean
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºç´¢å¼•'
        required: false
        default: false
        type: boolean
      deploy_message:
        description: 'éƒ¨ç½²è¯´æ˜ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨éƒ¨ç½²'
        type: string

env:
  VERCEL_ORG_ID: $ secrets.VERCEL_ORG_ID 
  VERCEL_PROJECT_ID: $ secrets.VERCEL_PROJECT_ID 
  VERCEL_TOKEN: $ secrets.VERCEL_TOKEN 

jobs:
  lint-and-test:
    name: ä»£ç æ£€æŸ¥ä¸æµ‹è¯•
    runs-on: ubuntu-latest
    if: ${{52}} != 'true'
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # è®¾ç½®Node.jsç¯å¢ƒ  
      - name: ğŸš€ è®¾ç½® Node.js $ matrix.node-version 
        uses: actions/setup-node@v4
        with:
          node-version: $ matrix.node-version 
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶
      - name: ğŸ—ƒï¸ éªŒè¯æ•°æ®æ–‡ä»¶å­˜åœ¨æ€§
        run: |
          echo "æ£€æŸ¥å¿…éœ€çš„æ•°æ®æ–‡ä»¶..."
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âš ï¸ è­¦å‘Š: IP2LOCATION-LITE-DB1.CSV æ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°"
            echo "ğŸ“¥ è¯·ä» lite.ip2location.com ä¸‹è½½æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ•°æ®æ–‡ä»¶éªŒè¯é€šè¿‡"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“Š æ•°æ®æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯:"
          wc -l data/IP2LOCATION-LITE-DB1.CSV
          ls -lh data/IP2LOCATION-LITE-DB1.CSV
      
      # æ„å»ºç´¢å¼•æ–‡ä»¶
      - name: ğŸ”¨ æ„å»ºIPåœ°ç†ä½ç½®ç´¢å¼•
        run: |
          if [ "${{53}}" == "true" ]; then
            echo "ğŸ”¨ å¼ºåˆ¶é‡æ–°æ„å»ºç´¢å¼•..."
            rm -f data/ip-ranges.json
          fi
          
          echo "å¼€å§‹æ„å»ºä¼˜åŒ–ç´¢å¼•æ–‡ä»¶..."
          node scripts/build-index.js
          echo "âœ… ç´¢å¼•æ„å»ºå®Œæˆ"
          
          # éªŒè¯ç´¢å¼•æ–‡ä»¶
          if [ -f "data/ip-ranges.json" ]; then
            echo "ğŸ“Š ç´¢å¼•æ–‡ä»¶ç»Ÿè®¡: $(wc -l < data/ip-ranges.json) æ¡è®°å½•"
            ls -lh data/ip-ranges.json
          else
            echo "âŒ ç´¢å¼•æ–‡ä»¶æ„å»ºå¤±è´¥"
            exit 1
          fi
      
      # ä»£ç è´¨é‡æ£€æŸ¥
      - name: ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "æ£€æŸ¥ä»£ç è¯­æ³•å’Œæ½œåœ¨é—®é¢˜..."
          
          # è¿è¡Œnpm auditæ£€æŸ¥å®‰å…¨æ¼æ´
          npm audit --audit-level=moderate || echo "âš ï¸ å‘ç°å®‰å…¨å»ºè®®ï¼Œè¯·å…³æ³¨"
          
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
      
      # æœ¬åœ°åŠŸèƒ½æµ‹è¯•
      - name: ğŸ§ª è¿è¡Œæœ¬åœ°APIæµ‹è¯•
        run: |
          echo "å¯åŠ¨æœ¬åœ°åŠŸèƒ½æµ‹è¯•..."
          
          # æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
          node -e "
          try {
            const { isValidIP } = require('./api/_lib/ipUtils.js');
            console.log('ğŸ§ª æµ‹è¯•IPéªŒè¯åŠŸèƒ½...');
            console.log('Valid IP test:', isValidIP('8.8.8.8'));
            console.log('Invalid IP test:', isValidIP('invalid'));
            console.log('âœ… æœ¬åœ°æµ‹è¯•é€šè¿‡');
          } catch(e) {
            console.log('âš ï¸ æœ¬åœ°æµ‹è¯•é‡åˆ°é—®é¢˜ï¼Œä½†ç»§ç»­éƒ¨ç½²');
          }
          "

  manual-deploy:
    name: æ‰‹åŠ¨éƒ¨ç½²
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: lint-and-test
    
    steps:
      # æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: ğŸ“‹ æ˜¾ç¤ºéƒ¨ç½²é…ç½®
        run: |
          echo "ğŸš€ æ‰‹åŠ¨éƒ¨ç½²å¯åŠ¨"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ‘¤ è§¦å‘ç”¨æˆ·: $toolu_01HV2RfVEMbJLpoMDtc8m37t"
          echo "ğŸŒ éƒ¨ç½²ç¯å¢ƒ: ${{54}}"
          echo "âš¡ è·³è¿‡æµ‹è¯•: ${{52}}"
          echo "ğŸ”¨ å¼ºåˆ¶é‡å»º: ${{53}}"
          echo "ğŸ’¬ éƒ¨ç½²è¯´æ˜: ${{55}}"
      
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶
      - name: ğŸ—ƒï¸ éªŒè¯æ•°æ®æ–‡ä»¶
        run: |
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âŒ éƒ¨ç½²å¤±è´¥: ç¼ºå°‘å¿…éœ€çš„æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ•°æ®æ–‡ä»¶éªŒè¯é€šè¿‡"
      
      # æ„å»ºç´¢å¼•
      - name: ğŸ”¨ æ„å»ºç´¢å¼•æ–‡ä»¶  
        run: |
          if [ "${{53}}" == "true" ]; then
            rm -f data/ip-ranges.json
            echo "ğŸ”¨ å¼ºåˆ¶é‡æ–°æ„å»ºç´¢å¼•..."
          fi
          node scripts/build-index.js
          echo "âœ… ç´¢å¼•æ„å»ºå®Œæˆ"
      
      # å®‰è£…Vercel CLI
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      # æ‹‰å–Vercelé…ç½®
      - name: â¬‡ï¸ åŒæ­¥ Vercel é…ç½®
        run: |
          if [ "${{54}}" == "production" ]; then
            vercel pull --yes --environment=production --token=$ secrets.VERCEL_TOKEN 
          else
            vercel pull --yes --environment=preview --token=$ secrets.VERCEL_TOKEN 
          fi
      
      # æ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: |
          if [ "${{54}}" == "production" ]; then
            vercel build --prod --token=$ secrets.VERCEL_TOKEN 
          else
            vercel build --token=$ secrets.VERCEL_TOKEN 
          fi
      
      # æ‰§è¡Œéƒ¨ç½²
      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
        id: manual-deploy-step
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ° ${{54}} ç¯å¢ƒ..."
          
          if [ "${{54}}" == "production" ]; then
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=$ secrets.VERCEL_TOKEN )
          else
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=$ secrets.VERCEL_TOKEN )
          fi
          
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²æˆåŠŸ: $DEPLOYMENT_URL"
          echo "ğŸ’¬ éƒ¨ç½²è¯´æ˜: ${{55}}"
      
      # éƒ¨ç½²æµ‹è¯•
      - name: ğŸ§ª éƒ¨ç½²åæµ‹è¯•
        run: |
          DEPLOYMENT_URL="${{56}}"
          echo "ğŸ” æµ‹è¯•éƒ¨ç½²ç»“æœ: $DEPLOYMENT_URL"
          sleep 20
          
          # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
          curl -f "$DEPLOYMENT_URL/api/health" -H "Accept: application/json" || echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥"
          
          # æµ‹è¯•IPæŸ¥è¯¢åŠŸèƒ½
          curl -f "$DEPLOYMENT_URL/api/lookup?ip=8.8.8.8" -H "Accept: application/json" || echo "âš ï¸ APIæµ‹è¯•å¤±è´¥"
          
          echo "âœ… éƒ¨ç½²æµ‹è¯•å®Œæˆ"
          echo "ğŸŒ è®¿é—®åœ°å€: $DEPLOYMENT_URL"

  deploy:
    name: è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main' && github.event_name != 'workflow_dispatch'
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶
      - name: ğŸ—ƒï¸ éªŒè¯æ•°æ®æ–‡ä»¶
        run: |
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âŒ éƒ¨ç½²å¤±è´¥: ç¼ºå°‘æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ•°æ®æ–‡ä»¶å°±ç»ª"
      
      # æ„å»ºç´¢å¼•
      - name: ğŸ”¨ æ„å»ºç´¢å¼•
        run: node scripts/build-index.js
      
      # å®‰è£…Vercel CLI
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      # éƒ¨ç½²æµç¨‹
      - name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        id: deploy-prod
        run: |
          vercel pull --yes --environment=production --token=$ secrets.VERCEL_TOKEN 
          vercel build --prod --token=$ secrets.VERCEL_TOKEN 
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=$ secrets.VERCEL_TOKEN )
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ: $DEPLOYMENT_URL"
      
      # ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
      - name: ğŸ¥ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
        run: |
          DEPLOYMENT_URL="${{57}}"
          echo "å¼€å§‹å¯¹ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå¥åº·æ£€æŸ¥..."
          
          # ç­‰å¾…éƒ¨ç½²å®Œå…¨ç”Ÿæ•ˆ
          sleep 30
          
          # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
          echo "ğŸ” æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹..."
          curl -f "$DEPLOYMENT_URL/api/health" -H "Accept: application/json" || {
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          }
          
          # æµ‹è¯•ä¸»é¡µ
          echo "ğŸ” æµ‹è¯•APIä¸»é¡µ..."
          curl -f "$DEPLOYMENT_URL/api" -H "Accept: application/json" || {
            echo "âŒ APIä¸»é¡µè®¿é—®å¤±è´¥"
            exit 1
          }
          
          # æµ‹è¯•å•ä¸ªIPæŸ¥è¯¢
          echo "ğŸ” æµ‹è¯•IPæŸ¥è¯¢åŠŸèƒ½..."
          curl -f "$DEPLOYMENT_URL/api/lookup?ip=8.8.8.8" -H "Accept: application/json" || {
            echo "âŒ IPæŸ¥è¯¢åŠŸèƒ½æµ‹è¯•å¤±è´¥"
            exit 1
          }
          
          echo "âœ… æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
          echo "ğŸ‰ GeoIP-API éƒ¨ç½²æˆåŠŸå¹¶æ­£å¸¸è¿è¡Œ"
          echo "ğŸŒ ç”Ÿäº§ç¯å¢ƒåœ°å€: $DEPLOYMENT_URL"

  preview-deploy:
    name: é¢„è§ˆç¯å¢ƒéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: ğŸ”¨ æ„å»ºç´¢å¼•
        run: node scripts/build-index.js
      
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      - name: ğŸš€ éƒ¨ç½²é¢„è§ˆç¯å¢ƒ
        id: preview-deploy
        run: |
          PREVIEW_URL=$(vercel deploy --token=$ secrets.VERCEL_TOKEN )
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "âœ… é¢„è§ˆéƒ¨ç½²æˆåŠŸ: $PREVIEW_URL"
      
      - name: ğŸ§ª é¢„è§ˆç¯å¢ƒæµ‹è¯•
        run: |
          PREVIEW_URL="${{58}}"
          echo "æµ‹è¯•é¢„è§ˆç¯å¢ƒ: $PREVIEW_URL"
          
          sleep 20
          
          # ç®€å•çš„åŠŸèƒ½æµ‹è¯•
          curl -f "$PREVIEW_URL/api/health" || echo "âš ï¸ é¢„è§ˆç¯å¢ƒå¥åº·æ£€æŸ¥è­¦å‘Š"
          curl -f "$PREVIEW_URL/api/lookup?ip=8.8.8.8" || echo "âš ï¸ é¢„è§ˆç¯å¢ƒAPIæµ‹è¯•è­¦å‘Š"
          
          echo "âœ… é¢„è§ˆç¯å¢ƒæµ‹è¯•å®Œæˆ"
          echo "ğŸ”— é¢„è§ˆåœ°å€: $PREVIEW_URL"
      
      - name: ğŸ’¬ æ·»åŠ PRè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{58}}';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ é¢„è§ˆéƒ¨ç½²æˆåŠŸï¼
              
              **é¢„è§ˆåœ°å€**: ${previewUrl}
              
              ### ğŸ§ª å¿«é€Ÿæµ‹è¯•é“¾æ¥:
              - [APIå¥åº·æ£€æŸ¥](${previewUrl}/api/health)
              - [APIä¿¡æ¯é¡µé¢](${previewUrl}/api)
              - [æµ‹è¯•IPæŸ¥è¯¢](${previewUrl}/api/lookup?ip=8.8.8.8)
              
              ### ğŸ“Š æµ‹è¯•å»ºè®®:
              - æµ‹è¯•å•ä¸ªIPæŸ¥è¯¢åŠŸèƒ½
              - æµ‹è¯•æ‰¹é‡æŸ¥è¯¢åŠŸèƒ½
              - éªŒè¯åŸŸåè§£æåŠŸèƒ½
              - æ£€æŸ¥å“åº”æ—¶é—´å’Œæ ¼å¼
              
              éƒ¨ç½²å°†åœ¨åˆå¹¶åˆ°mainåˆ†æ”¯åè‡ªåŠ¨å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒã€‚`
            });
