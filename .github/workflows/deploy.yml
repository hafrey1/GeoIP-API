name: GeoIP-API Verceléƒ¨ç½²

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'data/**'
      - 'scripts/**'
      - 'package.json'
      - 'vercel.json'
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'api/**'
      - 'data/**'
      - 'scripts/**'
      - 'package.json'
      - 'vercel.json'

env:
  VERCEL_ORG_ID: $ secrets.VERCEL_ORG_ID 
  VERCEL_PROJECT_ID: $ secrets.VERCEL_PROJECT_ID 
  VERCEL_TOKEN: $ secrets.VERCEL_TOKEN 

jobs:
  lint-and-test:
    name: ä»£ç æ£€æŸ¥ä¸æµ‹è¯•
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸš€ è®¾ç½® Node.js $ matrix.node-version 
        uses: actions/setup-node@v4
        with:
          node-version: $ matrix.node-version 
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶
      - name: ğŸ—ƒï¸ éªŒè¯æ•°æ®æ–‡ä»¶å­˜åœ¨æ€§
        run: |
          echo "æ£€æŸ¥å¿…éœ€çš„æ•°æ®æ–‡ä»¶..."
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âš ï¸  è­¦å‘Š: IP2LOCATION-LITE-DB1.CSV æ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°"
            echo "ğŸ“¥ è¯·ä»ä»¥ä¸‹åœ°å€ä¸‹è½½: https://lite.ip2location.com/database/ip-country"
            echo "ğŸ“ ä¸‹è½½åè¯·æ”¾ç½®åˆ° data/ ç›®å½•ä¸‹"
            exit 1
          fi
          echo "âœ… æ•°æ®æ–‡ä»¶éªŒè¯é€šè¿‡"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“Š æ•°æ®æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯:"
          wc -l data/IP2LOCATION-LITE-DB1.CSV
          ls -lh data/IP2LOCATION-LITE-DB1.CSV
      
      # æ„å»ºç´¢å¼•æ–‡ä»¶
      - name: ğŸ”¨ æ„å»ºIPåœ°ç†ä½ç½®ç´¢å¼•
        run: |
          echo "å¼€å§‹æ„å»ºä¼˜åŒ–ç´¢å¼•æ–‡ä»¶..."
          node scripts/build-index.js
          echo "âœ… ç´¢å¼•æ„å»ºå®Œæˆ"
          
          # éªŒè¯ç´¢å¼•æ–‡ä»¶
          if [ -f "data/ip-ranges.json" ]; then
            echo "ğŸ“Š ç´¢å¼•æ–‡ä»¶ç»Ÿè®¡: $(wc -l < data/ip-ranges.json) æ¡è®°å½•"
            ls -lh data/ip-ranges.json
          else
            echo "âŒ ç´¢å¼•æ–‡ä»¶æ„å»ºå¤±è´¥"
            exit 1
          fi
      
      # ä»£ç è´¨é‡æ£€æŸ¥
      - name: ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
        run: |
          echo "æ£€æŸ¥ä»£ç è¯­æ³•å’Œæ½œåœ¨é—®é¢˜..."
          # å¦‚æœæœ‰ESLinté…ç½®ï¼Œè¿è¡ŒESLint
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            npm run lint || echo "âš ï¸  ESLintæ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†ä¸é˜»æ­¢éƒ¨ç½²"
          fi
          
          # è¿è¡Œnpm auditæ£€æŸ¥å®‰å…¨æ¼æ´
          npm audit --audit-level=moderate || echo "âš ï¸  å‘ç°å®‰å…¨å»ºè®®ï¼Œè¯·å…³æ³¨"
          
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
      
      # æœ¬åœ°åŠŸèƒ½æµ‹è¯•
      - name: ğŸ§ª è¿è¡Œæœ¬åœ°APIæµ‹è¯•
        run: |
          echo "å¯åŠ¨æœ¬åœ°åŠŸèƒ½æµ‹è¯•..."
          
          # æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
          node -e "
          const { lookupIP } = require('./api/_lib/database.js');
          const { isValidIP } = require('./api/_lib/ipUtils.js');
          
          console.log('ğŸ§ª æµ‹è¯•IPéªŒè¯åŠŸèƒ½...');
          console.log('Valid IP test:', isValidIP('8.8.8.8'));
          console.log('Invalid IP test:', isValidIP('invalid'));
          
          console.log('ğŸ§ª æµ‹è¯•å®Œæˆ');
          " || echo "âš ï¸  æœ¬åœ°æµ‹è¯•é‡åˆ°é—®é¢˜ï¼Œä½†ç»§ç»­éƒ¨ç½²"

  deploy:
    name: éƒ¨ç½²åˆ°Vercel
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # éªŒè¯æ•°æ®æ–‡ä»¶ï¼ˆéƒ¨ç½²å‰å†æ¬¡ç¡®è®¤ï¼‰
      - name: ğŸ—ƒï¸ éƒ¨ç½²å‰æ•°æ®æ–‡ä»¶éªŒè¯
        run: |
          if [ ! -f "data/IP2LOCATION-LITE-DB1.CSV" ]; then
            echo "âŒ éƒ¨ç½²å¤±è´¥: ç¼ºå°‘å¿…éœ€çš„æ•°æ®æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… æ•°æ®æ–‡ä»¶å°±ç»ª"
      
      # æ„å»ºç´¢å¼•æ–‡ä»¶
      - name: ğŸ”¨ æ„å»ºç”Ÿäº§ç¯å¢ƒç´¢å¼•
        run: node scripts/build-index.js
      
      # å®‰è£…Vercel CLI
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      # æ‹‰å–Vercelé¡¹ç›®é…ç½®
      - name: â¬‡ï¸ åŒæ­¥ Vercel é¡¹ç›®é…ç½®
        run: vercel pull --yes --environment=production --token=$ env.VERCEL_TOKEN 
      
      # æ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: vercel build --prod --token=$ env.VERCEL_TOKEN 
      
      # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      - name: ğŸš€ éƒ¨ç½²åˆ° Vercel ç”Ÿäº§ç¯å¢ƒ
        id: deploy
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ°Vercelç”Ÿäº§ç¯å¢ƒ..."
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=$ env.VERCEL_TOKEN )
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²æˆåŠŸ: $DEPLOYMENT_URL"
      
      # éƒ¨ç½²åå¥åº·æ£€æŸ¥
      - name: ğŸ¥ éƒ¨ç½²åå¥åº·æ£€æŸ¥
        run: |
          DEPLOYMENT_URL="$ steps.deploy.outputs.deployment_url "
          echo "å¼€å§‹å¯¹ $DEPLOYMENT_URL è¿›è¡Œå¥åº·æ£€æŸ¥..."
          
          # ç­‰å¾…éƒ¨ç½²å®Œå…¨ç”Ÿæ•ˆ
          sleep 30
          
          # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
          echo "ğŸ” æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹..."
          curl -f "$DEPLOYMENT_URL/api/health" -H "Accept: application/json" || {
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          }
          
          # æµ‹è¯•ä¸»é¡µ
          echo "ğŸ” æµ‹è¯•APIä¸»é¡µ..."
          curl -f "$DEPLOYMENT_URL/api" -H "Accept: application/json" || {
            echo "âŒ APIä¸»é¡µè®¿é—®å¤±è´¥"
            exit 1
          }
          
          # æµ‹è¯•å•ä¸ªIPæŸ¥è¯¢
          echo "ğŸ” æµ‹è¯•IPæŸ¥è¯¢åŠŸèƒ½..."
          curl -f "$DEPLOYMENT_URL/api/lookup?ip=8.8.8.8" -H "Accept: application/json" || {
            echo "âŒ IPæŸ¥è¯¢åŠŸèƒ½æµ‹è¯•å¤±è´¥"
            exit 1
          }
          
          # æµ‹è¯•æ‰¹é‡æŸ¥è¯¢ï¼ˆç®€å•æµ‹è¯•ï¼‰
          echo "ğŸ” æµ‹è¯•æ‰¹é‡æŸ¥è¯¢åŠŸèƒ½..."
          curl -X POST "$DEPLOYMENT_URL/api/batch" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d '{"ips":["8.8.8.8","1.1.1.1"]}' || {
            echo "âŒ æ‰¹é‡æŸ¥è¯¢åŠŸèƒ½æµ‹è¯•å¤±è´¥"
            exit 1
          }
          
          echo "âœ… æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
          echo "ğŸ‰ GeoIP-API éƒ¨ç½²æˆåŠŸå¹¶æ­£å¸¸è¿è¡Œ"
          echo "ğŸŒ è®¿é—®åœ°å€: $DEPLOYMENT_URL"
      
      # æ€§èƒ½åŸºå‡†æµ‹è¯•
      - name: ğŸ“Š è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        run: |
          DEPLOYMENT_URL="$ steps.deploy.outputs.deployment_url "
          
          echo "ğŸ“Š å¼€å§‹æ€§èƒ½åŸºå‡†æµ‹è¯•..."
          
          # æµ‹è¯•å•æ¬¡æŸ¥è¯¢å“åº”æ—¶é—´
          echo "â±ï¸ å•æ¬¡æŸ¥è¯¢æ€§èƒ½æµ‹è¯•:"
          for i in {1..3}; do
            curl -w "å“åº”æ—¶é—´: %{time_total}s\n" -o /dev/null -s "$DEPLOYMENT_URL/api/lookup?ip=8.8.8.8"
          done
          
          echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"

  preview-deploy:
    name: é¢„è§ˆç¯å¢ƒéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'pull_request'
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸš€ è®¾ç½® Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      # å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci
      
      # æ„å»ºç´¢å¼•æ–‡ä»¶
      - name: ğŸ”¨ æ„å»ºé¢„è§ˆç¯å¢ƒç´¢å¼•
        run: node scripts/build-index.js
      
      # å®‰è£…Vercel CLI
      - name: ğŸ”§ å®‰è£… Vercel CLI
        run: npm install --global vercel@latest
      
      # éƒ¨ç½²åˆ°é¢„è§ˆç¯å¢ƒ
      - name: ğŸš€ éƒ¨ç½²åˆ° Vercel é¢„è§ˆç¯å¢ƒ
        id: preview-deploy
        run: |
          echo "å¼€å§‹éƒ¨ç½²åˆ°Vercelé¢„è§ˆç¯å¢ƒ..."
          PREVIEW_URL=$(vercel deploy --token=$ env.VERCEL_TOKEN )
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "âœ… é¢„è§ˆéƒ¨ç½²æˆåŠŸ: $PREVIEW_URL"
      
      # é¢„è§ˆç¯å¢ƒç®€å•æµ‹è¯•
      - name: ğŸ§ª é¢„è§ˆç¯å¢ƒåŠŸèƒ½æµ‹è¯•
        run: |
          PREVIEW_URL="$ steps.preview-deploy.outputs.preview_url "
          echo "æµ‹è¯•é¢„è§ˆç¯å¢ƒ: $PREVIEW_URL"
          
          sleep 20
          
          # ç®€å•çš„åŠŸèƒ½æµ‹è¯•
          curl -f "$PREVIEW_URL/api/health" || echo "âš ï¸ é¢„è§ˆç¯å¢ƒæµ‹è¯•è­¦å‘Š"
          curl -f "$PREVIEW_URL/api/lookup?ip=8.8.8.8" || echo "âš ï¸ é¢„è§ˆç¯å¢ƒæµ‹è¯•è­¦å‘Š"
          
          echo "âœ… é¢„è§ˆç¯å¢ƒæµ‹è¯•å®Œæˆ"
          echo "ğŸ”— é¢„è§ˆåœ°å€: $PREVIEW_URL"
      
      # åœ¨PRä¸­æ·»åŠ è¯„è®º
      - name: ğŸ’¬ æ·»åŠ PRè¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '$ steps.preview-deploy.outputs.preview_url ';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ é¢„è§ˆéƒ¨ç½²æˆåŠŸï¼
              
              **é¢„è§ˆåœ°å€**: ${previewUrl}
              
              ### ğŸ§ª å¿«é€Ÿæµ‹è¯•é“¾æ¥:
              - [APIå¥åº·æ£€æŸ¥](${previewUrl}/api/health)
              - [APIä¿¡æ¯é¡µé¢](${previewUrl}/api)
              - [æµ‹è¯•IPæŸ¥è¯¢](${previewUrl}/api/lookup?ip=8.8.8.8)
              
              ### ğŸ“Š æµ‹è¯•å»ºè®®:
              - æµ‹è¯•å•ä¸ªIPæŸ¥è¯¢åŠŸèƒ½
              - æµ‹è¯•æ‰¹é‡æŸ¥è¯¢åŠŸèƒ½
              - éªŒè¯åŸŸåè§£æåŠŸèƒ½
              - æ£€æŸ¥å“åº”æ—¶é—´å’Œæ ¼å¼
              
              éƒ¨ç½²å°†åœ¨åˆå¹¶åˆ°mainåˆ†æ”¯åè‡ªåŠ¨å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒã€‚`
            });
